name: Check Linked Issue

on:
  workflow_call:
    inputs:
      mode:
        description: 'Modes: strict, draft or comment'
        required: false
        default: 'comment'
        type: string
    secrets:
      PR_DRAFT_TOKEN:
        description: 'Token with permissions to modify pull requests'
        required: true

jobs:
  check-linked-issue:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    
    steps:
      - name: Check linked issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_DRAFT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('This workflow must be triggered by a pull_request event.');
              return;
            }

            const mode = ('${{ inputs.mode }}' || 'comment').trim().toLowerCase();
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;

            async function addComment(body) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }

            async function closePr() {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                state: 'closed',
              });
            }

            async function convertToDraft() {
              await github.graphql(
                `
                  mutation ConvertToDraft($id: ID!) {
                    convertPullRequestToDraft(input: { pullRequestId: $id }) {
                      pullRequest {
                        isDraft
                      }
                    }
                  }
                `,
                { id: pr.node_id }
              );
            }

            const result = await github.graphql(
              `
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    pullRequest(number: $number) {
                      closingIssuesReferences(first: 10) {
                        nodes {
                          number
                          title
                          state
                          url
                        }
                      }
                    }
                  }
                }
              `,
              {
                owner,
                repo,
                number: prNumber,
              }
            );

            const closingIssues = result.repository.pullRequest.closingIssuesReferences.nodes;

            // Filter for open issues
            const openIssues = closingIssues.filter(issue => issue.state === 'OPEN');
            const closedIssues = closingIssues.filter(issue => issue.state === 'CLOSED');

            if (openIssues.length > 0) {
              return;
            }

            let message = `Check-linked-issue: PR #${prNumber} does not reference any open issue.`;

            if (closedIssues.length > 0) {
              const closedList = closedIssues.map(issue => `#${issue.number}`).join(', ');
              message += ` Closed issue(s): ${closedList}.`;
            } else if (closingIssues.length === 0) {
              message += ' No linked issues found.';
            }

            if (mode === 'strict') {
              message += '\n\nClosing PR.';
            } else if (mode === 'draft') {
              message += '\n\nConverting to draft.';
            }

            await addComment(message);

            if (mode === 'strict') {
              await closePr();
              return;
            }

            if (mode === 'draft') {
              if (!pr.draft) {
                await convertToDraft();
              }
              return;
            }
