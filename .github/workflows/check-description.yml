name: Check PR Description

on:
  workflow_call:
    inputs:
      mode:
        description: 'Modes: strict, draft or comment'
        required: false
        default: 'comment'
        type: string

jobs:
  check-description:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    
    steps:
      - name: Check PR description
        id: check_description
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('This workflow must be triggered by a pull_request event.');
              return;
            }

            const rawMode = '${{ inputs.mode }}' || 'comment';
            const mode = rawMode.trim().toLowerCase();

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;

            console.log(`Mode: ${mode}`);
            console.log(`PR number: ${prNumber}`);
            console.log(`Current draft status: ${pr.draft}`);

            async function addComment(body) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }

            async function closePr() {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                state: 'closed',
              });
              console.log(`PR #${prNumber} closed (strict mode).`);
            }

            // To draft
            async function convertPrToDraft() {
              try {
                const result = await github.graphql(
                  `
                    mutation ConvertToDraft($id: ID!) {
                      convertPullRequestToDraft(input: { pullRequestId: $id }) {
                        pullRequest {
                          number
                          isDraft
                        }
                      }
                    }
                  `,
                  { id: pr.node_id }
                );

                const converted = result?.convertPullRequestToDraft?.pullRequest;
                if (converted?.isDraft) {
                  console.log(
                    `PR #${converted.number} successfully converted to draft`
                  );
                } else {
                  console.log(
                    'convertPullRequestToDraft mutation returned without isDraft=true, ' +
                    'but no error was thrown.'
                  );
                }
              } catch (error) {
                console.error('Failed to convert PR to draft via GraphQL:', error);
              }
            }

            const hasDescription =
              typeof pr.body === 'string' && pr.body.trim().length > 0;

            if (hasDescription) {
              console.log('PR description is filled.');
              await addComment(
                `Check-description: PR #${prNumber} has a non-empty description.`
              );
              return;
            }

            console.log('PR description is empty.');

            await addComment(
              `Check-description: PR #${prNumber} has an empty description. ` +
              `Please add a meaningful description.`
            );
            console.log('Warning comment added.');

            if (mode === 'strict') {
              await closePr();
            } else if (mode === 'draft') {
              if (!pr.draft) {
                await convertPrToDraft();
              } else {
                console.log('PR is already in draft status, nothing to do.');
              }
            } else {
              console.log('Comment-only mode: no further action taken.');
            }
