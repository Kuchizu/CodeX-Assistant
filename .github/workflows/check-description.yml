name: Check PR Description

on:
  workflow_call:
    inputs:
      mode:
        description: 'Modes: strict, draft or comment'
        required: false
        default: 'comment'
        type: string

jobs:
  check-description:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('This workflow must be triggered by a pull_request event.');
              return;
            }

            const mode = ('${{ inputs.mode }}' || 'comment').trim().toLowerCase();
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;

            async function addComment(body) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }

            async function closePr() {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                state: 'closed',
              });
            }

            async function convertToDraft() {
              await github.graphql(
                `
                  mutation ConvertToDraft($id: ID!) {
                    convertPullRequestToDraft(input: { pullRequestId: $id }) {
                      pullRequest {
                        isDraft
                      }
                    }
                  }
                `,
                { id: pr.node_id }
              );
            }

            async function reopenPr() {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                state: 'open',
              });
            }

            async function markReadyForReview() {
              await github.graphql(
                `
                  mutation MarkReady($id: ID!) {
                    markPullRequestReadyForReview(input: { pullRequestId: $id }) {
                      pullRequest {
                        isDraft
                      }
                    }
                  }
                `,
                { id: pr.node_id }
              );
            }

            const hasDescription =
              typeof pr.body === 'string' && pr.body.trim().length > 0;

            // If description is now valid, check if we need to reopen/unmark draft
            if (hasDescription) {
              if (pr.state === 'closed' && mode === 'strict') {
                await reopenPr();
                await addComment(`### PR Reopened\n\nDescription added. This PR has been reopened.`);
              } else if (pr.draft && mode === 'draft') {
                await markReadyForReview();
                await addComment(`### PR Ready for Review\n\nDescription added. This PR has been marked as ready for review.`);
              }
              return;
            }

            let message = `### PR Description Required\n\n`;
            message += `This pull request is missing a description.\n\n`;
            message += `**Why this matters:**\n`;
            message += `A good description helps reviewers understand your changes, speeds up the review process, and serves as documentation for future reference.\n\n`;

            if (mode === 'strict') {
              message += `**Action taken:** This PR has been closed. Add a description and it will be reopened.`;
            } else if (mode === 'draft') {
              message += `**Action taken:** This PR has been converted to draft. Add a description and it will be marked as ready for review.`;
            } else {
              message += `Please update this PR with a meaningful description.`;
            }

            await addComment(message);

            if (mode === 'strict') {
              await closePr();
              return;
            }

            if (mode === 'draft') {
              if (!pr.draft) {
                await convertToDraft();
              }
              return;
            }
